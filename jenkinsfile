pipeline {
    agent any
    
    environment {
        AWS_REGION = 'ap-south-2'
        AWS_ACCOUNT_ID = sh(script: 'aws sts get-caller-identity --query Account --output text', returnStdout: true).trim()
        ECR_REGISTRY = "922754696039.dkr.ecr.ap-south-2.amazonaws.com"
        ECR_REPOSITORY = 'my-web-app'
        IMAGE_TAG = "${BUILD_NUMBER}"
        AWS_CREDENTIALS = 'aws-credentials'
        CONTAINER_NAME = 'my-web-app-container'
        HOST_PORT = '8081'
        APP_URL = 'http://18.61.33.140:8081'
    }
    
    stages {
        stage('Checkout Code') {
            steps {
                echo '========================================='
                echo '=== Stage 1: Fetching code from GitHub ==='
                echo '========================================='
                checkout scm
            }
        }
        
        stage('Build Application') {
            steps {
                script {
                    echo '========================================='
                    echo '=== Stage 2: Building Application with Maven ==='
                    echo '========================================='
                    sh 'mvn clean package -DskipTests'
                }
            }
        }
        
        stage('Run Unit Tests') {
            steps {
                script {
                    echo '========================================='
                    echo '=== Stage 3: Running Unit Tests ==='
                    echo '========================================='
                    sh 'mvn test'
                }
            }
            post {
                always {
                    junit '**/target/surefire-reports/*.xml'
                }
            }
        }
        
        stage('Build Docker Image') {
            steps {
                script {
                    echo '========================================='
                    echo '=== Stage 4: Building Docker Image ==='
                    echo '========================================='
                    sh "docker build -t ${ECR_REPOSITORY}:${IMAGE_TAG} ."
                    sh "docker tag ${ECR_REPOSITORY}:${IMAGE_TAG} ${ECR_REPOSITORY}:latest"
                    echo "Docker image built successfully: ${ECR_REPOSITORY}:${IMAGE_TAG}"
                }
            }
        }
        
        stage('Push to ECR') {
            steps {
                script {
                    echo '========================================='
                    echo '=== Stage 5: Pushing to AWS ECR ==='
                    echo '========================================='
                    withAWS(credentials: AWS_CREDENTIALS, region: AWS_REGION) {
                        sh """
                            echo "Logging into ECR..."
                            aws ecr get-login-password --region ${AWS_REGION} | docker login --username AWS --password-stdin ${ECR_REGISTRY}
                            
                            echo "Tagging images..."
                            docker tag ${ECR_REPOSITORY}:${IMAGE_TAG} ${ECR_REGISTRY}/${ECR_REPOSITORY}:${IMAGE_TAG}
                            docker tag ${ECR_REPOSITORY}:${IMAGE_TAG} ${ECR_REGISTRY}/${ECR_REPOSITORY}:latest
                            
                            echo "Pushing images to ECR..."
                            docker push ${ECR_REGISTRY}/${ECR_REPOSITORY}:${IMAGE_TAG}
                            docker push ${ECR_REGISTRY}/${ECR_REPOSITORY}:latest
                            
                            echo "Images pushed successfully!"
                        """
                    }
                }
            }
        }
        
        stage('Deploy to EC2') {
            steps {
                script {
                    echo '========================================='
                    echo '=== Stage 6: Deploying to EC2 Instance ==='
                    echo '========================================='
                    withAWS(credentials: AWS_CREDENTIALS, region: AWS_REGION) {
                        sh """
                            echo "Logging into ECR for deployment..."
                            aws ecr get-login-password --region ${AWS_REGION} | docker login --username AWS --password-stdin ${ECR_REGISTRY}
                            
                            echo "Stopping old container (if exists)..."
                            docker stop ${CONTAINER_NAME} || true
                            docker rm ${CONTAINER_NAME} || true
                            
                            echo "Removing old images..."
                            docker rmi ${ECR_REGISTRY}/${ECR_REPOSITORY}:latest || true
                            
                            echo "Pulling latest image from ECR..."
                            docker pull ${ECR_REGISTRY}/${ECR_REPOSITORY}:${IMAGE_TAG}
                            
                            echo "Starting new container..."
                            docker run -d \
                                --name ${CONTAINER_NAME} \
                                -p ${HOST_PORT}:8080 \
                                --restart unless-stopped \
                                -e ENVIRONMENT=production \
                                ${ECR_REGISTRY}/${ECR_REPOSITORY}:${IMAGE_TAG}
                            
                            echo "Waiting for application to start..."
                            sleep 15
                            
                            echo "Checking if container is running..."
                            docker ps | grep ${CONTAINER_NAME}
                        """
                    }
                }
            }
        }
        
        stage('Verify Deployment') {
            steps {
                script {
                    echo '========================================='
                    echo '=== Stage 7: Verifying Deployment ==='
                    echo '========================================='
                    sh """
                        echo "Testing health endpoint..."
                        max_attempts=10
                        attempt=1
                        
                        while [ \$attempt -le \$max_attempts ]; do
                            echo "Attempt \$attempt of \$max_attempts..."
                            if curl -f http://localhost:${HOST_PORT}/health; then
                                echo "✅ Application is healthy and running!"
                                exit 0
                            fi
                            echo "Waiting for application to be ready..."
                            sleep 5
                            attempt=\$((attempt + 1))
                        done
                        
                        echo "❌ Application health check failed after \$max_attempts attempts"
                        exit 1
                    """
                }
            }
        }
        
        stage('Cleanup') {
            steps {
                script {
                    echo '========================================='
                    echo '=== Stage 8: Cleaning Up Old Images ==='
                    echo '========================================='
                    sh """
                        echo "Removing dangling images..."
                        docker image prune -f
                        
                        echo "Cleanup complete!"
                    """
                }
            }
        }
    }
    
    post {
        success {
            echo '========================================='
            echo '=== ✅ PIPELINE COMPLETED SUCCESSFULLY! ==='
            echo '========================================='
            emailext (
                subject: "✅ SUCCESS: Jenkins Pipeline - ${env.JOB_NAME} - Build #${env.BUILD_NUMBER}",
                body: """
                    <html>
                    <body style="font-family: Arial, sans-serif;">
                        <h2 style="color: #28a745;">✅ Pipeline Executed Successfully!</h2>
                        <hr>
                        <table style="border-collapse: collapse; width: 100%;">
                            <tr>
                                <td style="padding: 8px; border: 1px solid #ddd;"><strong>Project:</strong></td>
                                <td style="padding: 8px; border: 1px solid #ddd;">${env.JOB_NAME}</td>
                            </tr>
                            <tr>
                                <td style="padding: 8px; border: 1px solid #ddd;"><strong>Build Number:</strong></td>
                                <td style="padding: 8px; border: 1px solid #ddd;">${env.BUILD_NUMBER}</td>
                            </tr>
                            <tr>
                                <td style="padding: 8px; border: 1px solid #ddd;"><strong>Build Status:</strong></td>
                                <td style="padding: 8px; border: 1px solid #ddd; color: #28a745;"><strong>SUCCESS</strong></td>
                            </tr>
                            <tr>
                                <td style="padding: 8px; border: 1px solid #ddd;"><strong>Image Tag:</strong></td>
                                <td style="padding: 8px; border: 1px solid #ddd;">${IMAGE_TAG}</td>
                            </tr>
                            <tr>
                                <td style="padding: 8px; border: 1px solid #ddd;"><strong>Application URL:</strong></td>
                                <td style="padding: 8px; border: 1px solid #ddd;">
                                    <a href="${APP_URL}">${APP_URL}</a>
                                </td>
                            </tr>
                            <tr>
                                <td style="padding: 8px; border: 1px solid #ddd;"><strong>Duration:</strong></td>
                                <td style="padding: 8px; border: 1px solid #ddd;">${currentBuild.durationString}</td>
                            </tr>
                        </table>
                        <hr>
                        <p><strong>Deployment Details:</strong></p>
                        <ul>
                            <li>Docker Image: ${ECR_REGISTRY}/${ECR_REPOSITORY}:${IMAGE_TAG}</li>
                            <li>Container Name: ${CONTAINER_NAME}</li>
                            <li>Port: ${HOST_PORT}</li>
                        </ul>
                        <p>
                            <a href="${env.BUILD_URL}" style="background-color: #007bff; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px;">
                                View Console Output
                            </a>
                        </p>
                        <hr>
                        <p style="color: #666; font-size: 12px;">
                            This email was sent automatically by Jenkins CI/CD Pipeline.<br>
                            Timestamp: ${new Date()}
                        </p>
                    </body>
                    </html>
                """,
                to: 'lokhi123@gmail.com',
                mimeType: 'text/html',
                attachLog: true
            )
        }
        
        failure {
            echo '========================================='
            echo '=== ❌ PIPELINE FAILED! ==='
            echo '========================================='
            emailext (
                subject: "❌ FAILURE: Jenkins Pipeline - ${env.JOB_NAME} - Build #${env.BUILD_NUMBER}",
                body: """
                    <html>
                    <body style="font-family: Arial, sans-serif;">
                        <h2 style="color: #dc3545;">❌ Pipeline Execution Failed!</h2>
                        <hr>
                        <table style="border-collapse: collapse; width: 100%;">
                            <tr>
                                <td style="padding: 8px; border: 1px solid #ddd;"><strong>Project:</strong></td>
                                <td style="padding: 8px; border: 1px solid #ddd;">${env.JOB_NAME}</td>
                            </tr>
                            <tr>
                                <td style="padding: 8px; border: 1px solid #ddd;"><strong>Build Number:</strong></td>
                                <td style="padding: 8px; border: 1px solid #ddd;">${env.BUILD_NUMBER}</td>
                            </tr>
                            <tr>
                                <td style="padding: 8px; border: 1px solid #ddd;"><strong>Build Status:</strong></td>
                                <td style="padding: 8px; border: 1px solid #ddd; color: #dc3545;"><strong>FAILURE</strong></td>
                            </tr>
                            <tr>
                                <td style="padding: 8px; border: 1px solid #ddd;"><strong>Failed Stage:</strong></td>
                                <td style="padding: 8px; border: 1px solid #ddd;">${env.STAGE_NAME}</td>
                            </tr>
                            <tr>
                                <td style="padding: 8px; border: 1px solid #ddd;"><strong>Duration:</strong></td>
                                <td style="padding: 8px; border: 1px solid #ddd;">${currentBuild.durationString}</td>
                            </tr>
                        </table>
                        <hr>
                        <p><strong>Action Required:</strong></p>
                        <ul>
                            <li>Check the console output for error details</li>
                            <li>Review the failed stage logs</li>
                            <li>Fix the issue and trigger a new build</li>
                        </ul>
                        <p>
                            <a href="${env.BUILD_URL}console" style="background-color: #dc3545; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px;">
                                View Console Output
                            </a>
                        </p>
                        <hr>
                        <p style="color: #666; font-size: 12px;">
                            This email was sent automatically by Jenkins CI/CD Pipeline.<br>
                            Timestamp: ${new Date()}
                        </p>
                    </body>
                    </html>
                """,
                to: 'lokhi123@gmail.com',
                mimeType: 'text/html',
                attachLog: true
            )
        }
        
        unstable {
            echo '========================================='
            echo '=== ⚠️ PIPELINE UNSTABLE ==='
            echo '========================================='
            emailext (
                subject: "⚠️ UNSTABLE: Jenkins Pipeline - ${env.JOB_NAME} - Build #${env.BUILD_NUMBER}",
                body: """
                    <html>
                    <body style="font-family: Arial, sans-serif;">
                        <h2 style="color: #ffc107;">⚠️ Pipeline Unstable</h2>
                        <p>The build completed but some tests may have failed.</p>
                        <p><strong>Build Number:</strong> ${env.BUILD_NUMBER}</p>
                        <p><a href="${env.BUILD_URL}">View Build Details</a></p>
                    </body>
                    </html>
                """,
                to: 'lokhi123@gmail.com',
                mimeType: 'text/html'
            )
        }
        
        always {
            echo '========================================='
            echo '=== Pipeline Execution Completed ==='
            echo '========================================='
            echo "Total Duration: ${currentBuild.durationString}"
            cleanWs()
        }
    }
}